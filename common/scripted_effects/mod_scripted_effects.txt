update_leader_after_modification = {
	if = {
		limit = {
			is_leader_tier = leader_tier_default
			has_any_chosen_one_leader_trait = no
		}
		# Remove all applicable leader traits
		remove_trait = leader_trait_erudite
		remove_trait = leader_trait_cyborg
		remove_trait = leader_trait_limited_cyborg
		remove_trait = leader_trait_psionic
		# Add the correct leader trait based on the species
		species = {
			if = {
				limit = {
					has_trait = trait_erudite
				}
				prev = {
					add_trait = {
						trait = leader_trait_erudite
						show_message = no
					}
				}
			}
			if = {
				limit = {
					has_trait = trait_cybernetic
				}
				prev = {
					add_trait = {
						trait = leader_trait_cyborg
						show_message = no
					}
				}
			}
			if = {
				limit = {
					has_trait = trait_limited_cybernetic
				}
				prev = {
					add_trait = {
						trait = leader_trait_limited_cyborg
						show_message = no
					}
				}
			}
			if = {
				limit = {
					has_trait = trait_psionic
				}
				prev = {
					add_trait = {
						trait = leader_trait_psionic
						show_message = no
					}
				}
			}
		}
	}
}

create_cybernetic_species_mod = {
	species = {
		modify_species = {
			effect = {
				create_species = {
					is_mod = yes
					name = this
					plural = this
					class = this
					portrait = this
					traits = this
					can_be_modified = this
					homeworld = this
					namelist = this
					gender = this
					traits = {
						ideal_planet_class = this
						trait = trait_cybernetic
					}
				}
			}
		}
		save_event_target_as = changing_species
	}
	owner = {
		every_owned_pop_group = {
			limit = {
				is_exact_same_species = event_target:changing_species
			}
			change_species = last_created_species
		}
		every_owned_leader = {
			limit = {
				is_exact_same_species = event_target:changing_species
			}
			change_species = last_created_species
		}
		every_pool_leader = {
			limit = {
				is_exact_same_species = event_target:changing_species
			}
			change_species = last_created_species
		}
		every_envoy = {
			limit = {
				is_exact_same_species = event_target:changing_species
			}
			change_species = last_created_species
		}
		every_owned_army = {
			limit = {
				exists = species
				is_exact_same_species = event_target:changing_species
			}
			change_species = last_created_species
		}
		every_controlled_ship = {
			limit = {
				is_ship_class = shipclass_colonizer
				is_exact_same_species = event_target:changing_species
			}
			change_species = last_created_species
		}
	}
}

create_cyber_species_effect = {
	species = {
		modify_species = {
			effect = {
				create_species = {
					is_mod = yes
					name = this
					plural = this
					class = this
					portrait = this
					traits = this
					can_be_modified = this
					homeworld = this
					namelist = this
					gender = this
					traits = {
						ideal_planet_class = this
						trait = trait_cybernetic
					}
				}
				last_created_species = {
					save_global_event_target_as = cyberspecies@prev
				}
			}
		}
	}
}

upgrade_to_psionic_race = {
	species = {
		modify_species = {
			remove_trait = trait_latent_psionic
			add_trait = trait_psionic
			effect = {
				create_species = {
					name = this
					portrait = this
					plural = this
					homeworld = this
					class = this
					traits = this
					is_mod = yes
					can_be_modified = this
					gender = this
					namelist = this
					effect = {
						save_event_target_as = last_created_species
					}
				}
			}
		}
		save_event_target_as = changing_species
	}
	change_dominant_species = {
		species = event_target:last_created_species
		change_all = yes
	}
	owner = {
		every_owned_pop_group = {
			limit = {
				is_exact_same_species = event_target:changing_species
			}
			change_species = last_created_species
		}
		every_owned_leader = {
			limit = {
				is_exact_same_species = event_target:changing_species
			}
			change_species = last_created_species
		}
		every_pool_leader = {
			limit = {
				is_exact_same_species = event_target:changing_species
			}
			change_species = last_created_species
		}
		every_envoy = {
			limit = {
				is_exact_same_species = event_target:changing_species
			}
			change_species = last_created_species
		}
		every_owned_army = {
			limit = {
				exists = species
				is_exact_same_species = event_target:changing_species
			}
			change_species = last_created_species
		}
		every_controlled_ship = {
			limit = {
				is_ship_class = shipclass_colonizer
				is_exact_same_species = event_target:changing_species
			}
			change_species = last_created_species
		}
	}
}

upgrade_mechanical_to_machine = {
	species = {
		modify_species = {
			remove_trait = trait_mechanical
			add_trait = trait_machine_unit
			effect = {
				create_species = {
					name = this
					portrait = this
					plural = this
					homeworld = this
					class = MACHINE
					traits = this
					is_mod = yes
					can_be_modified = this
					gender = this
					namelist = this
					effect = {
						save_event_target_as = last_created_species
					}
				}
			}
		}
		save_event_target_as = changing_species
	}
	change_dominant_species = {
		species = event_target:last_created_species
		change_all = yes
	}
	owner = {
		every_owned_pop_group = {
			limit = {
				is_exact_same_species = event_target:changing_species
			}
			change_species = last_created_species
		}
		every_owned_leader = {
			limit = {
				is_exact_same_species = event_target:changing_species
			}
			change_species = last_created_species
		}
		every_pool_leader = {
			limit = {
				is_exact_same_species = event_target:changing_species
			}
			change_species = last_created_species
		}
		every_envoy = {
			limit = {
				is_exact_same_species = event_target:changing_species
			}
			change_species = last_created_species
		}
		every_owned_army = {
			limit = {
				exists = species
				is_exact_same_species = event_target:changing_species
			}
			change_species = last_created_species
		}
		every_controlled_ship = {
			limit = {
				is_ship_class = shipclass_colonizer
				is_exact_same_species = event_target:changing_species
			}
			change_species = last_created_species
		}
	}
}
